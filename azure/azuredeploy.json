{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "auxvmSshPublicKey": {
      "type": "string",
      "defaultValue": "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDJoJu7pd69WA4qWeDw1dUMFceYNwsr7SqbVqvXxNvk5BqLANBHAvyZCnRd3qyjDozMzxjAR/6b0wT5YFermGcM7CPhMYFo7dxPzHZm4bBsp7whVnWLtxEq1dFoo+a7UN3sstxoIMuAcodBHUpSbI74am8TqYD8m9hY2bchOFy7aYKCCm1i3Z1jdf3lG214S/nFKGgVJtZtBf2BkkrrQ2Lxqm+Gt8ic9O57vj4YR9I7A437zaa7IB6q9CXAuEt9cJoa1EFM6CG/DDhAWduGtnowT/LpSIwtDB2wZg9uVMfUGB42ovE/Xp+C8UFWQu3cSod4QBPY2k8As653Mn0f9nf5",
      "metadata": {
        "description": "Configure all linux machines with the SSH public key string, for example 'ssh-rsa AAAAB...snip...UcyupgH azureuser@linuxvm'"
      }
    },
    "auxvmSize": {
      "type": "string",
      "defaultValue": "Standard_DS2_v2",
      "allowedValues": [
        "Standard_B2s",
        "Standard_B2ms",
        "Standard_D2s_v3",
        "Standard_D2_v3",
        "Standard_DS2_v2",
        "Standard_D2_v2",
        "Standard_DS2",
        "Standard_D2",
        "Standard_A2_v2",
        "Standard_A2"
      ],
      "metadata": {
        "description": "The virutal machine size to use as AuxVM."
      }
    },
    "kubernetesVersion": {
      "type": "string",
      "defaultValue": "1.13.5",
      "allowedValues": [
        "1.13.5"
      ],
      "metadata": {
        "description": "The version of the Kubernetes running in AKS."
      }
    },
    "kubernetesNodeSize": {
      "type": "string",
      "defaultValue": "Standard_DS2_v2",
      "allowedValues": [
        "Standard_B1s",
        "Standard_B1ms",
        "Standard_A1_v2",
        
        "Standard_B2s",
        "Standard_B2ms",
        "Standard_D2s_v3",
        "Standard_D2_v3",
        "Standard_DS2_v2",
        "Standard_D2_v2",
        "Standard_DS2",
        "Standard_D2",
        "Standard_A2_v2",
        "Standard_A2"
      ],
      "metadata": {
        "description": "The virutal machine size to use as kubernetes nodes. Added some smaller from https://docs.microsoft.com/en-us/azure/virtual-machines/linux/sizes-general"
      }
    },
    "servicePrincipalAppId": {
      "type": "string",
      "defaultValue": "ddaac2d7-ef70-4ae0-8bc9-b4c2b92abe03",
      "metadata": {
        "description": "Service Principal App ID (also called Client ID) that has contributor rights to the subscription used for this deployment. It is used by the Kubernetes cluster to dynamically manage resources (e.g. user-defined load balancers)."
      }
    },
    "servicePrincipalAppKey": {
      "type": "securestring",
      "defaultValue": "/z.t1Inb9JlzLdWjZe/4hZ:mgG4L]5w/",
      "metadata": {
        "description": "Service Principal App Key (also called Client Secret) that has contributor rights to the subscription used for this deployment. It is used by the Kubernetes cluster to dynamically manage resources (e.g. user-defined load balancers)."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Location for all resources."
      }
    },
    "acrSku": {
      "type": "string",
      "metadata": {
        "description": "Tier of your Azure Container Registry."
      },
      "defaultValue": "Basic",
      "allowedValues": [
        "Basic",
        "Standard",
        "Premium"
      ]
    },
    "jenkinsAdminPassword": {
      "type": "securestring",
      "defaultValue": "admin",
      "metadata": {
        "description": "Admin password for created Jenkins instance."
      }
    },
    "applicationGitUrl": {
      "type": "string",
      "defaultValue": "https://github.com/elos-tech/openshift-cicd-app",
      "metadata": {
        "description": "Application source GIT repository URL."
      }
    }
  },
  "variables": {
    "adminUsername": "azureuser",
    "acrAdminUserEnabled": true,
    "acrName": "[concat('acr',uniqueString(resourceGroup().id))]",
    "resourcePrefix": "auxvm",
    "vmName": "[concat(variables('resourcePrefix'), '-vm')]",
    "bootstrapExtensionName": "[concat(variables('resourcePrefix'), '-bootstrap')]",
    "auxvmDeploymentName": "auxvm-deployment",
    "aksName": "aks-cluster",
    "aksDnsPrefix": "[concat('aks', uniqueString(resourceGroup().id))]",
    "artifactsLocation": "https://raw.githubusercontent.com/elos-tech/kubernetes-cicd/master/",
    "extensionScript": "bootstrap-wrapper.sh",
    "artifactsLocationSasToken": "",
    "customScriptTemplateUrl": "[uri(variables('artifactsLocation'), concat('azure/nested/customscript.json', variables('artifactsLocationSasToken')))]",
    "auxvmTemplateUrl": "[uri(variables('artifactsLocation'), concat('azure/nested/auxvm.json', variables('artifactsLocationSasToken')))]"
  },
  "resources": [
    {
      "name": "[variables('auxvmDeploymentName')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2018-05-01",
      "dependsOn": [ ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('auxvmTemplateUrl')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "sshPublicKey": {
            "value": "[parameters('auxvmSshPublicKey')]"
          },
          "virtualMachineSize": {
            "value": "[parameters('auxvmSize')]"
          },
          "location": {
            "value": "[parameters('location')]"
          }
        }
      }
    },
    {
      "name": "[variables('bootstrapExtensionName')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2018-05-01",
      "dependsOn": [
        "[variables('auxvmDeploymentName')]",
        "[resourceId('Microsoft.ContainerService/managedClusters', variables('aksName'))]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('customScriptTemplateUrl')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "extensionName": {
            "value": "[variables('bootstrapExtensionName')]"
          },
          "vmName": {
            "value": "[variables('vmName')]"
          },
          "fileUris": {
            "value": [
                "[concat(variables('artifactsLocation'), '/scripts/aks/', variables('extensionScript'), variables('artifactsLocationSasToken'))]"
            ]
          },
          "commandToExecute": {
            "value": "[concat('./', variables('extensionScript'), ' --app_id \"', parameters('servicePrincipalAppId'), '\" --app_key \"', parameters('servicePrincipalAppKey'), '\" --subscription_id \"', subscription().subscriptionId, '\" --tenant_id \"', subscription().tenantId, '\" --resource_group \"', resourceGroup().name, '\" --cluster_name \"', variables('aksName'), '\" --jenkins_admin_password \"', parameters('jenkinsAdminPassword'), '\" --application_git_url \"', parameters('applicationGitUrl'), '\" --registry_name \"', variables('acrName'), '\" --location \"', parameters('location'), '\"')]"
          }
        }
      }
    },
    {
      "apiVersion": "2018-03-31",
      "type": "Microsoft.ContainerService/managedClusters",
      "name": "[variables('aksName')]",
      "location": "[parameters('location')]",
      "properties": {
        "kubernetesVersion": "[parameters('kubernetesVersion')]",
        "dnsPrefix": "[variables('aksDnsPrefix')]",
        "enableRBAC": false,
        "agentPoolProfiles": [
          {
            "name": "agentpool",
            "count": 2,
            "vmSize": "[parameters('kubernetesNodeSize')]",
            "osType": "Linux",
            "storageProfile": "ManagedDisks",
            "storageTier": "Standard_LRS"
          }
        ],
        "linuxProfile": {
          "adminUsername": "[variables('adminUsername')]",
          "ssh": {
            "publicKeys": [
              {
                "path": "[concat('/home/', variables('adminUsername'), '/.ssh/authorized_keys')]",
                "keyData": "[parameters('auxvmSshPublicKey')]"
              }
            ]
          }
        },
        "servicePrincipalProfile": {
          "ClientId": "[parameters('servicePrincipalAppId')]",
          "Secret": "[parameters('servicePrincipalAppKey')]"
        }
      },
      "dependsOn": [
      ]
    },
    {
      "name": "[variables('acrName')]",
      "type": "Microsoft.ContainerRegistry/registries",
      "apiVersion": "2017-10-01",
      "location": "[parameters('location')]",
      "comments": "Container registry for storing docker images",
      "tags": {
        "displayName": "Container Registry",
        "container.registry": "[variables('acrName')]"
      },
      "sku": {
        "name": "[parameters('acrSku')]",
        "tier": "[parameters('acrSku')]"
      },
      "properties": {
        "adminUserEnabled": "[variables('acrAdminUserEnabled')]"
      }
    }
  ],
  "outputs": {
    "Jenkins url": {
      "value": "[concat('https://jenkins.', replace(replace(reference(variables('bootstrapExtensionName')).outputs.instanceView.value.statuses[0].message, 'Enable succeeded: \n[stdout]\n', ''), '\n[stderr]\n', ''))]",
      "type": "string"
    },
    "Sonarqube url": {
      "value": "[concat('https://sonarqube.', replace(replace(reference(variables('bootstrapExtensionName')).outputs.instanceView.value.statuses[0].message, 'Enable succeeded: \n[stdout]\n', ''), '\n[stderr]\n', ''))]",
      "type": "string"
    },
    "Nexus url": {
      "value": "[concat('https://nexus.', replace(replace(reference(variables('bootstrapExtensionName')).outputs.instanceView.value.statuses[0].message, 'Enable succeeded: \n[stdout]\n', ''), '\n[stderr]\n', ''))]",
      "type": "string"
    },
    "Application dev url": {
      "value": "[concat('https://application-dev.', replace(replace(reference(variables('bootstrapExtensionName')).outputs.instanceView.value.statuses[0].message, 'Enable succeeded: \n[stdout]\n', ''), '\n[stderr]\n', ''))]",
      "type": "string"
    },
    "Application prod url": {
      "value": "[concat('https://application-prod.', replace(replace(reference(variables('bootstrapExtensionName')).outputs.instanceView.value.statuses[0].message, 'Enable succeeded: \n[stdout]\n', ''), '\n[stderr]\n', ''))]",
      "type": "string"
    },
    "Auxvm ssh connection command": {
      "type": "string",
      "value": "[concat('ssh ', variables('adminUsername'), '@', reference(variables('auxvmDeploymentName')).outputs.auxvmFqdn.value)]"
    },
    "Authenticate kubectl tool via az CLI( not final implementation)": {
      "type": "string",
      "value": "[concat('az aks get-credentials --resource-group ', resourceGroup().name ' --name ', variables('aksName'), '--admin']"
    },
    
    "Kubernetes master fqdn": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.ContainerService/managedClusters', variables('aksName'))).fqdn]"
    },
    "ACR fqdn": {
      "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries',variables('acrName')),'2017-10-01').loginServer]",
      "type": "string"
    }
  }
}
